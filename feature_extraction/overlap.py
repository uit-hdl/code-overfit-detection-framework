import os
import monai.transforms as mt
import argparse
import pickle
from collections import defaultdict
from tqdm import tqdm
from pathlib import Path
from sklearn.mixture import GaussianMixture
from pathlib import Path

parser = argparse.ArgumentParser(description='Compute overlaps')

parser.add_argument('--embeddings_path', default='./out/MoCo/embeddings/test_lungscc_embedding.pkl', type=str, help="location of embedding pkl from feature_extraction.py")
parser.add_argument('--out_dir', default='./out', type=str, help='path to save computed overlaps')

def ensure_dir_exists(path):
    dest_dir = os.path.dirname(path)
    if not os.path.exists(dest_dir):
        Path(dest_dir).mkdir(parents=True, exist_ok=True)


args = parser.parse_args()

if __name__ == "__main__":
    features = pickle.load(open(args.embeddings_path, 'rb'))
    number_of_unique_inst = len(set(map(lambda s: s.split("-")[1], features.keys())))

    cluster_dst = os.path.join(args.out_dir, 'cluster', f'gmm_{number_of_unique_inst}.pkl')
    if os.path.exists(cluster_dst):
        cluster = pickle.load(open(cluster_dst, 'rb'))
    else:
        cluster = GaussianMixture(n_components=number_of_unique_inst, random_state=9001)
        cluster = cluster.fit([item[0] for sublist in features.values() for item in sublist])
        ensure_dir_exists(cluster_dst)
        pickle.dump(cluster, open(cluster_dst, 'wb'))

    # Get number of unique slides in dl
    # Approach below doesn't work: the results are random from the model. So, let's just use the GMM approach instead
    # slide_extractor = InceptionV4(num_classes=128)
    # load_model(slide_extractor, args.feature_extractor)
    # slide_extractor.last_linear = nn.Linear(1536, number_of_unique_inst) # the linear layer removes our dependency/link to the key encoder
    # slide_extractor.to('cuda')
    # feature_extractor = nn.DataParallel(feature_extractor, device_ids=device_ids)
    # slide_embedding, _ = get_embeddings_bagging(slide_extractor, dl, False)
    # TODO: use GMM to decide this. For fuzzy memberships, maybe knn?
    #institution_guess = [(np.argmax(x[0]), x[1]) for y in slide_embedding.values() for x in y]
    institution_guess = [(cluster.predict([x[0]])[0], x[1]) for y in features.values() for x in y]
    # I want to know how many slides from the same institution that end up in the same bag
    # count how many slides are from each institution
    gt_institution_count = defaultdict(int)
    institution_count = defaultdict(lambda: defaultdict(dict))
    for (i,slide) in institution_guess:
        institution = os.path.dirname(slide).split("-")[1]
        if institution not in institution_count[i]:
            institution_count[i][institution] = 0
        institution_count[i][institution] += 1

        gt_institution_count[institution] += 1
    print(institution_count)
    print(gt_institution_count)
    overlap_count = defaultdict(lambda: defaultdict(int))
    for bag,d in institution_count.items():
        for inst_l,count_l in d.items():
            for inst_r, count_r in d.items():
                if inst_l == inst_r:
                    continue
                overlap_count[inst_l][inst_r] += min(count_l, count_r)

    overlap_percent = defaultdict(lambda: {})
    for inst_l,d in overlap_count.items():
        for inst_r, count in d.items():
            if gt_institution_count[inst_r] < gt_institution_count[inst_l]:
                overlap_percent[inst_l][inst_r] = count / gt_institution_count[inst_r]
            else:
                overlap_percent[inst_l][inst_r] = overlap_count[inst_r][inst_l] / gt_institution_count[inst_l]
    import ipdb; ipdb.set_trace()
    pass

# defaultdict(<function <lambda> at 0x7f9506ca1fc0>, {'66': {'77': 0.6858974358974359, '63': 1.0, '22': 0.6103806228373703, '60': 0.6397415185783522, '21': 0.5873161764705882, '43': 0.9501359927470535, '34': 0.6002728512960437, '18': 0.7443365695792881, '56': 0.9436241610738255, '90': 0.6800766283524904, '33': 0.5702746365105008, '39': 0.4753968253968254, '85': 0.8379772961816305, '46': 1.0, 'LA': 1.0, '96': 0.8371040723981901, '37': 0.9535783365570599, '58': 1.0, 'NC': 1.0, '94': 0.7333333333333333, 'NK': 0.7058823529411765}, '77': {'66': 0.6858974358974359, '63': 0.8111111111111111, '22': 0.5833333333333334, '60': 0.6762820512820513, '21': 0.7676282051282052, '43': 0.5016025641025641, '34': 0.7243589743589743, '18': 0.45145631067961167, '56': 0.5432692307692307, '90': 0.49038461538461536, '33': 0.2681744749596123, '39': 0.5208333333333334, '85': 1.0, '46': 0.7014925373134329, 'LA': 0.7235294117647059, '96': 0.9819004524886877, '37': 0.528046421663443, '58': 0.2804878048780488, 'NC': 0.826530612244898, '94': 0.6666666666666666, 'NK': 0.6588235294117647}, '63': {'66': 1.0, '77': 0.8111111111111111, '22': 0.9611111111111111, '60': 0.8777777777777778, '21': 0.6166666666666667, '43': 0.9833333333333333, '34': 0.8555555555555555, '18': 0.5055555555555555, '56': 0.95, '90': 0.9777777777777777, '33': 0.5444444444444444, '39': 0.5944444444444444, '85': 1.0, '46': 0.4701492537313433, 'LA': 0.34705882352941175, '96': 0.4388888888888889, '37': 0.7888888888888889, '58': 0.24390243902439024, 'NC': 0.2111111111111111, '94': 0.14166666666666666, 'NK': 0.27058823529411763}, '22': {'66': 0.6103806228373703, '77': 0.5833333333333334, '63': 0.9611111111111111, '60': 0.4862681744749596, '21': 0.5193014705882353, '43': 0.670897552130553, '34': 0.46505190311418687, '18': 0.8300970873786407, '56': 0.7624161073825504, '90': 0.5229885057471264, '33': 0.9483037156704361, '39': 0.3825396825396825, '85': 0.6062283737024221, '46': 1.0, 'LA': 0.9823529411764705, '96': 0.832579185520362, '37': 0.6847195357833655, '58': 1.0, 'NC': 0.673469387755102, '94': 0.575, 'NK': 0.6470588235294118}, '60': {'66': 0.6397415185783522, '77': 0.6762820512820513, '63': 0.8777777777777778, '22': 0.4862681744749596, '21': 0.6672794117647058, '43': 0.46328195829555757, '34': 0.7883683360258481, '18': 0.6634304207119741, '56': 0.7986577181208053, '90': 0.4109195402298851, '33': 0.4701130856219709, '39': 0.5436187399030694, '85': 0.8844911147011308, '46': 0.9402985074626866, 'LA': 0.9294117647058824, '96': 0.8959276018099548, '37': 0.7098646034816247, '58': 0.34146341463414637, 'NC': 0.673469387755102, '94': 1.0, 'NK': 1.0}, '21': {'66': 0.5873161764705882, '77': 0.7676282051282052, '63': 0.6166666666666667, '22': 0.5193014705882353, '60': 0.6672794117647058, '43': 0.37775735294117646, '34': 0.8125, '18': 0.7038834951456311, '56': 0.6456375838926175, '90': 0.2672413793103448, '33': 0.5153473344103393, '39': 0.5955882352941176, '85': 1.0, '46': 0.9029850746268657, 'LA': 0.9529411764705882, '96': 0.9049773755656109, '37': 0.6460348162475822, '58': 0.23170731707317074, 'NC': 0.8010204081632653, '94': 0.925, 'NK': 1.0}, '43': {'66': 0.9501359927470535, '77': 0.5016025641025641, '63': 0.9833333333333333, '22': 0.670897552130553, '60': 0.46328195829555757, '21': 0.37775735294117646, '34': 0.4669084315503173, '18': 0.49029126213592233, '56': 0.6845637583892618, '90': 0.6082375478927203, '33': 0.41518578352180935, '39': 0.37533998186763373, '85': 0.885766092475068, '46': 0.9925373134328358, 'LA': 0.9117647058823529, '96': 0.6199095022624435, '37': 0.7156673114119922, '58': 0.7195121951219512, 'NC': 0.6938775510204082, '94': 0.4583333333333333, 'NK': 0.5764705882352941}, '34': {'66': 0.6002728512960437, '77': 0.7243589743589743, '63': 0.8555555555555555, '22': 0.46505190311418687, '60': 0.7883683360258481, '21': 0.8125, '43': 0.4669084315503173, '18': 0.7588996763754046, '56': 0.738255033557047, '90': 0.3448275862068966, '33': 0.6025848142164781, '39': 0.6404761904761904, '85': 0.961118690313779, '46': 0.917910447761194, 'LA': 0.9647058823529412, '96': 0.9819004524886877, '37': 0.8955512572533849, '58': 0.6219512195121951, 'NC': 1.0, '94': 1.0, 'NK': 1.0}, '18': {'66': 0.7443365695792881, '77': 0.45145631067961167, '63': 0.5055555555555555, '22': 0.8300970873786407, '60': 0.6634304207119741, '21': 0.7038834951456311, '43': 0.49029126213592233, '34': 0.7588996763754046, '56': 0.6375404530744336, '90': 0.3656957928802589, '33': 0.5420711974110033, '39': 0.6553398058252428, '85': 0.7621359223300971, '46': 0.7164179104477612, 'LA': 0.8470588235294118, '96': 0.6470588235294118, '37': 0.5473887814313346, '58': 0.5609756097560976, 'NC': 0.7193877551020408, '94': 0.85, 'NK': 0.9058823529411765}, '56': {'66': 0.9436241610738255, '77': 0.5432692307692307, '63': 0.95, '22': 0.7624161073825504, '60': 0.7986577181208053, '21': 0.6456375838926175, '43': 0.6845637583892618, '34': 0.738255033557047, '18': 0.6375404530744336, '90': 0.6550335570469799, '33': 0.5088852988691438, '39': 0.6214765100671141, '85': 0.9154362416107382, '46': 1.0, 'LA': 0.8705882352941177, '96': 0.8235294117647058, '37': 0.6382978723404256, '58': 0.9878048780487805, 'NC': 0.5816326530612245, '94': 0.5416666666666666, 'NK': 0.8705882352941177}, '90': {'66': 0.6800766283524904, '77': 0.49038461538461536, '63': 0.9777777777777777, '22': 0.5229885057471264, '60': 0.4109195402298851, '21': 0.2672413793103448, '43': 0.6082375478927203, '34': 0.3448275862068966, '18': 0.3656957928802589, '56': 0.6550335570469799, '33': 0.4168012924071082, '39': 0.23659003831417624, '85': 0.6360153256704981, '46': 0.9850746268656716, 'LA': 0.6588235294117647, '96': 0.6470588235294118, '37': 0.4816247582205029, '58': 1.0, 'NC': 0.45918367346938777, '94': 0.26666666666666666, 'NK': 0.3764705882352941}, '33': {'66': 0.5702746365105008, '77': 0.2681744749596123, '63': 0.5444444444444444, '22': 0.9483037156704361, '60': 0.4701130856219709, '21': 0.5153473344103393, '43': 0.41518578352180935, '34': 0.6025848142164781, '18': 0.5420711974110033, '56': 0.5088852988691438, '90': 0.4168012924071082, '39': 0.4184168012924071, '85': 0.6155088852988692, '46': 0.8432835820895522, 'LA': 0.6529411764705882, '96': 0.39819004524886875, '37': 0.3539651837524178, '58': 0.8170731707317073, 'NC': 0.47959183673469385, '94': 0.43333333333333335, 'NK': 0.5764705882352941}, '39': {'66': 0.4753968253968254, '77': 0.5208333333333334, '63': 0.5944444444444444, '22': 0.3825396825396825, '60': 0.5436187399030694, '21': 0.5955882352941176, '43': 0.37533998186763373, '34': 0.6404761904761904, '18': 0.6553398058252428, '56': 0.6214765100671141, '90': 0.23659003831417624, '33': 0.4184168012924071, '85': 0.7468253968253968, '46': 0.9328358208955224, 'LA': 0.8529411764705882, '96': 0.8552036199095022, '37': 0.6073500967117988, '58': 0.2926829268292683, 'NC': 0.6377551020408163, '94': 1.0, 'NK': 1.0}, '85': {'66': 0.8379772961816305, '77': 1.0, 63': 1.0, '22': 0.6062283737024221, '60': 0.8844911147011308, '21': 1.0, '43': 0.885766092475068, '34': 0.961118690313779, '18': 0.7621359223300971, '56': 0.9154362416107382, '90': 0.6360153256704981, '33': 0.6155088852988692, '39': 0.7468253968253968, '46': 1.0, 'LA': 1.0, '96': 1.0, '37': 1.0, '58': 0.5853658536585366, 'NC': 1.0, '94': 1.0, 'NK': 1.0}, '46': {'66': 1.0, '77': 0.7014925373134329, '63': 0.4701492537313433, '22': 1.0, '60': 0.9402985074626866, '21': 0.9029850746268657, '43': 0.9925373134328358, '34': 0.917910447761194, '18': 0.7164179104477612, '56': 1.0, '90': 0.9850746268656716, '33': 0.8432835820895522, '39': 0.9328358208955224, '85': 1.0, 'LA': 0.7089552238805971, '96': 0.40298507462686567, '37': 0.8955223880597015, '58': 0.23170731707317074, 'NC': 0.5597014925373134, '94': 0.21666666666666667, 'NK': 0.2}, 'LA': {'66': 1.0, '77': 0.7235294117647059, '63': 0.34705882352941175, '22': 0.9823529411764705, '60': .9294117647058824, '21': 0.9529411764705882, '43': 0.9117647058823529, '34': 0.9647058823529412, '18': 0.8470588235294118, '56': 0.8705882352941177, '90': 0.6588235294117647, '33': 0.6529411764705882, '39': 0.8529411764705882, '85': 1.0, '46': 0.7089552238805971, '96': 0.3411764705882353, '37': 0.9882352941176471, '58': 0.14634146341463414, 'NC': 0.5823529411764706, '94': 0.4666666666666667, 'NK': 0.3764705882352941}, '96': {'66': 0.8371040723981901, '77': 0.9819004524886877, '63': 0.4388888888888889, '22': 0.832579185520362, '60': 0.8959276018099548, '21': 0.9049773755656109, '43': 0.6199095022624435, '34': 0.9819004524886877, '18': 0.6470588235294118, '56': 0.8235294117647058, '90': 0.6470588235294118, '33': 0.39819004524886875, '39': 0.8552036199095022, '85': 1.0, '46': 0.40298507462686567, 'LA': 0.3411764705882353, '37': 0.579185520361991, '58': 0.06097560975609756, 'NC': 0.30612244897959184, '94': 0.275, 'NK': 0.4235294117647059}, '37': {'66': 0.9535783365570599, '77': 0.528046421663443, '63': 0.7888888888888889, '22': 0.6847195357833655, '60': 0.7098646034816247, '21': 0.6460348162475822, '43': 0.7156673114119922, '34': 0.8955512572533849, '18': 0.5473887814313346, '56': 0.6382978723404256, '90': 0.4816247582205029, '33': 0.3539651837524178, '39': 0.6073500967117988, '85': 1.0, '46': 0.8955223880597015, 'LA': 0.9882352941176471, '96': 0.579185520361991, '58': 0.21951219512195122, 'NC': 0.9285714285714286, '94': 0.5583333333333333, 'NK': 0.5529411764705883}, '58': {'66': 1.0, '77': 0.2804878048780488, '63': 0.24390243902439024, '22': 1.0,'60': 0.34146341463414637, '21': 0.23170731707317074, '43': 0.7195121951219512, '34': 0.6219512195121951, '18': 0.5609756097560976, '56': 0.9878048780487805, '90': 1.0, '33': 0.8170731707317073, '39': 0.2926829268292683, '85': 0.5853658536585366, '46': 0.23170731707317074, 'LA': 0.14634146341463414, '96': 0.06097560975609756, '37': 0.21951219512195122, 'NC': 0.25609756097560976, '94': 0.024390243902439025}, 'NC': {'66': 1.0, '77': 0.826530612244898, '63': 0.2111111111111111, '22': 0.673469387755102, '60': 0.673469387755102, '21': 0.8010204081632653, '43': 0.6938775510204082, '34': 1.0, '18': 0.7193877551020408, '56': 0.5816326530612245, '90': 0.45918367346938777, '33': 0.47959183673469385, '39': 0.6377551020408163, '85': 1.0, '46': 0.5597014925373134, 'LA': 0.5823529411764706, '96': 0.30612244897959184, '37': 0.9285714285714286, '58': 0.25609756097560976, '94': 0.48333333333333334, 'NK': 0.3411764705882353}, '94': {'66': 0.7333333333333333, '77': 0.6666666666666666, '63': 0.14166666666666666, '22': 0.575, '60': 1.0, '21': 0.925, '43': 0.4583333333333333, '34': 1.0, '18': 0.85, '56': 0.5416666666666666, '90': 0.26666666666666666, '39': 1.0, '85': 1.0, '46': 0.21666666666666667, '33': 0.43333333333333335, 'LA': 0.4666666666666667, '96': .275, '37': 0.5583333333333333, '58': 0.024390243902439025, 'NC': 0.48333333333333334, 'NK': 0.5176470588235295}, 'NK': {'66': 0.7058823529411765, '77': 0.6588235294117647, '63': 0.27058823529411763, '22': 0.6470588235294118, '60': 1.0, '21': 1.0, '43': 0.5764705882352941, '34': 1.0, '18': 0.9058823529411765, '56': 0.8705882352941177, '90': 0.3764705882352941, '85': 1.0, '39': 1.0, '46': 0.2, '94': 0.5176470588235295, '33': 0.5764705882352941, 'LA': 0.3764705882352941, '96': 0.4235294117647059, '37': 0.5529411764705883, 'NC': 0.3411764705882353}})ipdb> p overlap_percent['63']{'66': 1.0, '77': 0.8111111111111111, '22': 0.9611111111111111, '60': 0.8777777777777778, '21': 0.6166666666666667, '43': 0.9833333333333333, '34': 0.8555555555555555, '18': 0.5055555555555555, '56': 0.95, '90': 0.9777777777777777, '33': 0.5444444444444444, '39': 0.5944444444444444, '85': 1.0, '46': 0.4701492537313433, 'LA': 0.34705882352941175, '96': 0.4388888888888889, '37': 0.7888888888888889, '58': 0.24390243902439024, 'NC': 0.2111111111111111, '94': 0.14166666666666666, 'NK': 0.27058823529411763}
# ipdb> p overlap_percent['63']
#{'66': 1.0, '77': 0.8111111111111111, '22': 0.9611111111111111, '60': 0.8777777777777778, '21': 0.6166666666666667, '43': 0.9833333333333333, '34': 0.8555555555555555, '18': 0.5055555555555555, '56': 0.95, '90': 0.9777777777777777, '33': 0.5444444444444444, '39': 0.5944444444444444, '85': 1.0, '46': 0.4701492537313433, 'LA': 0.34705882352941175, '96': 0.4388888888888889, '37': 0.7888888888888889, '58': 0.24390243902439024, 'NC': 0.2111111111111111, '94': 0.14166666666666666, 'NK': 0.27058823529411763}


#{'66': 1.0, '77': 0.8, '22': 0.9722222222222222, '60': 0.8333333333333334, '21': 0.8444444444444444, '43': 0.9611111111111111, '34': 0.8888888888888888, '18': 0.6277777777777778, '56': 0.9666666666666667, '90': 0.9888888888888889, '33': 0.6166666666666667, '85': 1.0, '39': 0.8222222222222222, '46': 0.48507462686567165, '94': 0.15833333333333333, 'LA': 0.3941176470588235, '96': 0.45, '37': 0.7277777777777777, '58': 0.2073170731707317, 'NC': 0.2611111111111111, 'NK': 0.18823529411764706}


